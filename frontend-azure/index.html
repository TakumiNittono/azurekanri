<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>貯水槽修理案件管理システム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background: #f7f9fb; }
    .required::after { content: " *"; color: red; }
    .loading, .loading-overlay, .error-message { display: none; }
    .loading-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
  </style>
</head>

<body>

<!-- ナビ -->
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">
      <i class="bi bi-tools"></i> 貯水槽修理案件管理システム
    </span>
  </div>
</nav>

<div class="container my-4">

  <!-- ===== 修理案件入力 ===== -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-clipboard-plus"></i> 修理案件入力</h5>
    </div>

    <div class="card-body">
      <form id="caseForm">

        <div class="mb-3">
          <label class="form-label required">案件名</label>
          <input class="form-control" id="title" required>
        </div>

        <div class="mb-3">
          <label class="form-label required">修理種別</label>
          <input class="form-control" id="type" required>
        </div>

        <div class="mb-3">
          <label class="form-label required">緊急度</label>
          <select class="form-select" id="priority" required>
            <option value="">選択</option>
            <option>高</option>
            <option>中</option>
            <option>低</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label required">現場情報</label>
          <input class="form-control" id="location" required>
        </div>

        <div class="mb-3">
          <label class="form-label required">貯水槽</label>
          <input class="form-control" id="tank" required>
        </div>

        <div class="mb-3">
          <label class="form-label">詳細説明</label>
          <textarea class="form-control" id="detail" rows="3"></textarea>
        </div>

        <div id="errorMessage" class="alert alert-danger error-message"></div>

        <button class="btn btn-primary w-100" id="submitBtn">
          <i class="bi bi-search"></i> RAG検索を実行
        </button>

        <div class="loading text-center mt-3" id="loading">
          <div class="spinner-border text-primary"></div>
          <p class="mt-2">処理中...</p>
        </div>

      </form>
    </div>
  </div>

  <!-- ===== 案件一覧 ===== -->
  <h4 class="mb-3">
    <i class="bi bi-list-ul"></i> 登録済み案件一覧（新しい順）
  </h4>

  <div id="casesList" class="row g-3"></div>

</div>

<!-- ローディングオーバーレイ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="bg-white p-4 rounded text-center">
    <div class="spinner-border text-primary mb-3"></div>
    <h6>AI処理中…</h6>
  </div>
</div>

<script>
/* ===============================
   修理案件登録 + RAG
================================ */
const form = document.getElementById('caseForm');
const loading = document.getElementById('loading');
const overlay = document.getElementById('loadingOverlay');
const errorMessage = document.getElementById('errorMessage');

form.addEventListener('submit', async e => {
  e.preventDefault();
  errorMessage.style.display = 'none';

  const payload = {
    title: title.value,
    type: type.value,
    priority: priority.value,
    location: location.value,
    tank: tank.value,
    detail: detail.value
  };

  try {
    loading.style.display = 'block';
    overlay.style.display = 'flex';

    const res = await fetch('/api/cases', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error('保存失敗');

    await res.json();
    await loadCases();   // ★ ここがUI直結

    form.reset();

  } catch (err) {
    errorMessage.textContent = err.message;
    errorMessage.style.display = 'block';
  } finally {
    loading.style.display = 'none';
    overlay.style.display = 'none';
  }
});

/* ===============================
   案件一覧（createdAt 降順）
================================ */
async function loadCases() {
  const res = await fetch('/api/cases');
  const data = await res.json();

  const list = document.getElementById('casesList');
  list.innerHTML = '';

  data.items
    .sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt))
    .forEach(c => {
      list.innerHTML += `
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5>${c.title}</h5>
              <p class="mb-1"><strong>種別:</strong> ${c.type}</p>
              <p class="mb-1"><strong>緊急度:</strong> ${c.priority}</p>
              <p class="mb-1"><strong>場所:</strong> ${c.location}</p>
              <p class="mb-1"><strong>貯水槽:</strong> ${c.tank}</p>
              <p class="text-muted small mt-2">
                登録日時: ${new Date(c.createdAt).toLocaleString()}
              </p>
            </div>
          </div>
        </div>
      `;
    });
}

/* ===============================
   初期処理
================================ */
document.addEventListener('DOMContentLoaded', async () => {
  await loadCases();
  try {
    const r = await fetch('/api/health');
    console.log('health:', await r.json());
  } catch {}
});
</script>

</body>
</html>
