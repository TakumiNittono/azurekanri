# 貯水槽修理案件管理システム 要件定義書

## 1. システム概要

### 1.1 目的
ビルメンテナンス業務において、貯水槽の修理案件を下請け業者に回す際の判断支援を行うRAG（Retrieval-Augmented Generation）を活用した業務支援Webアプリケーション。

### 1.2 対象業務範囲
- **対象**：貯水槽の修理案件のみ
- **対象外**：点検・清掃・定期点検

### 1.3 業務目的
- 修理内容に応じた適切な下請け業者選定の支援
- 修理金額の妥当性判断支援
- 見積書・発注書作成の効率化
- 判断理由を説明できる状態の実現
- Knowledgeの中身を管理者がコントロールできること

### 1.4 システム構成
- **Backend**：FastAPI
- **RAG**：LlamaIndex
- **LLM**：OpenAI API（モデルは抽象化）
- **Knowledge形式**：txtファイル（`knowledge/`ディレクトリ配下）
  - 既存Knowledge：`/Users/takuminittono/Desktop/ragstudy/ラグルール/knowledge/`に30個のtxtファイルが存在
  - ファイル一覧は`knowledge_index.md`に記載
- **UI**：Web（一般ユーザー画面 + 管理者画面）
- **DB**：PoCではログ保存用途のみ（SQLite推奨）

### 1.5 ユーザー種別
- **一般ユーザー**：修理案件の入力、RAG回答の確認、見積書・発注書ドラフトの生成
- **管理者（admin）**：Knowledge管理、ログ閲覧、システム設定

---

## 2. 業務フロー（To-Be）

### 2.1 修理案件発生から下請け発注までの流れ

```
[1] 修理案件発生
    ↓
[2] 一般ユーザーがシステムに案件情報を入力
    - 貯水槽の状態（漏水・腐食・ひび割れ・バルブ故障・蓋の破損など）
    - 緊急度（緊急・通常・計画）
    - 現場情報（場所・規模・設備状況）
    ↓
[3] RAG検索・回答生成（自動）
    - 内部質問1：修理種別に応じた適切な業者選定基準
    - 内部質問2：類似事例の価格相場
    - 内部質問3：緊急度に応じた対応可否
    - 内部質問4：リスク・法令・安全要件
    ↓
[4] RAG回答の表示（判断支援情報）
    - 推奨業者（複数候補）
    - 想定価格帯
    - 判断理由（参照したKnowledgeファイル名付き）
    - リスク・注意事項
    ↓
[5] 一般ユーザーが回答を確認・判断
    - AIの回答を参考に最終判断
    - 必要に応じて手動修正
    ↓
[6] 見積書・発注書ドラフト生成
    - RAG回答を基にテンプレートから生成
    - ユーザーが最終確認・修正
    ↓
[7] 下請け業者への発注確定
```

### 2.2 RAGを呼び出すタイミング

- **タイミング1**：案件情報入力完了時（自動）
- **タイミング2**：ユーザーが「再検索」ボタンを押した時（手動）
- **タイミング3**：Knowledge更新後の初回検索時（自動的に最新Knowledgeを使用）

### 2.3 人が判断する部分／AIが支援する部分の切り分け

| 項目 | AIの役割 | 人の役割 |
|------|---------|---------|
| 業者選定 | 候補業者の提示と選定理由の説明 | 最終的な業者決定 |
| 価格判断 | 相場情報の提示と妥当性の目安 | 最終的な価格承認 |
| 緊急度判断 | 過去事例に基づく緊急度の目安 | 最終的な緊急度決定 |
| リスク評価 | 法令・安全要件のチェックリスト提示 | リスクの最終評価 |
| 見積書作成 | ドラフト生成 | 内容の最終確認・修正 |

**重要**：AIは「判断支援者」であり、最終決定は人間が行う。

### 2.4 adminがKnowledgeを変更した場合の反映フロー

```
[1] adminがKnowledgeファイルを追加・更新・削除
    ↓
[2] adminが「Knowledge再読み込み」ボタンを実行
    ↓
[3] システムがknowledge/ディレクトリをスキャン
    ↓
[4] LlamaIndexで再index実行
    - 既存indexを破棄
    - 全txtファイルを再読み込み
    - 新しいindexを作成
    ↓
[5] 再index完了通知をadminに表示
    ↓
[6] 以降のRAG検索で最新Knowledgeが使用される
```

**注意**：再index中はRAG検索を一時停止（またはキューイング）する。

---

## 3. 機能要件（一般ユーザー）

### 3.1 修理案件入力機能

#### 3.1.1 入力項目
- **案件ID**：自動生成（例：REP-2024-001）
- **案件名**：必須（例：「本館貯水槽漏水修理」）
- **修理種別**：必須、選択式
  - 漏水
  - 腐食
  - ひび割れ
  - バルブ故障
  - 蓋の破損
  - その他（自由記述）
- **緊急度**：必須、選択式
  - 緊急（24時間以内）
  - 通常（1週間以内）
  - 計画（1ヶ月以内）
- **現場情報**：必須
  - 場所（建物名・階数など）
  - 貯水槽規模（容量・サイズ）
  - 設備状況（設置年数・前回修理日など）
- **詳細説明**：任意（自由記述）
- **入力日時**：自動記録

#### 3.1.2 入力画面要件
- フォーム形式のWeb画面
- 必須項目のバリデーション
- 入力内容の一時保存機能（ローカルストレージ推奨）

### 3.2 RAG検索・回答生成機能

#### 3.2.1 検索実行
- 案件情報入力完了後、自動的にRAG検索を実行
- 検索中はローディング表示
- 検索結果は画面に表示

#### 3.2.2 回答内容
RAG回答には以下を必ず含める：

1. **推奨業者候補**（最大3社）
   - 業者名（仮データ）
   - 選定理由
   - 対応可能な緊急度
   - 想定価格帯

2. **想定価格情報**
   - 相場価格帯（最低〜最高）
   - 人件費目安
   - 材料費目安
   - 高額/低額ケースの説明

3. **判断理由**
   - 参照したKnowledgeファイル名の一覧
   - 各ファイルから抽出した根拠情報
   - 類似事例の有無

4. **リスク・注意事項**
   - 法令要件
   - 安全上の注意点
   - 過去事例からの教訓

5. **緊急度評価**
   - AIによる緊急度評価
   - 評価理由

### 3.3 回答表示機能

#### 3.3.1 表示形式
- カード形式で各項目を表示
- 判断理由は折りたたみ可能なセクション
- 参照Knowledgeファイル名はクリックで詳細表示可能

#### 3.3.2 操作機能
- **再検索**：同じ案件情報で再検索実行
- **回答のコピー**：回答内容をクリップボードにコピー
- **PDF出力**：回答をPDF形式でダウンロード（PoCでは簡易実装）

### 3.4 見積書・発注書ドラフト生成機能

#### 3.4.1 生成内容
- RAG回答を基に、テンプレートから見積書・発注書のドラフトを生成
- 以下の項目を自動入力：
  - 案件情報
  - 推奨業者情報
  - 想定価格
  - 作業内容
  - 注意事項

#### 3.4.2 編集機能
- 生成されたドラフトをユーザーが編集可能
- 編集後、PDF形式でダウンロード可能

### 3.5 PoC向け簡易UI要件

- レスポンシブデザイン（PC・タブレット対応）
- シンプルなデザイン（BootstrapまたはTailwind CSS推奨）
- ローディング表示
- エラーメッセージ表示

---

## 4. 機能要件（管理者：admin）

### 4.1 Knowledge管理機能

#### 4.1.1 Knowledgeファイル一覧表示
- `knowledge/`ディレクトリ内の全txtファイルを一覧表示
  - 既存Knowledgeディレクトリ：`/Users/takuminittono/Desktop/ragstudy/ラグルール/knowledge/`
  - システム内でこのディレクトリを参照する設定が必要
- 表示項目：
  - ファイル名
  - ファイルサイズ
  - 最終更新日時
  - ファイル種別（price_*、contractor_*、repair_*など）
- ファイル名で検索・フィルタリング可能
- ファイル種別でフィルタリング可能

#### 4.1.2 Knowledgeファイル内容閲覧
- ファイル名をクリックで内容を表示
- テキスト形式で表示
- 長いファイルはスクロール可能
- 編集モードへの切り替えボタン（将来拡張用）

#### 4.1.3 新規Knowledgeファイル追加
- 「新規追加」ボタンで追加画面を表示
- 入力項目：
  - ファイル名（必須、txt拡張子）
  - ファイル内容（テキストエリア）
- ファイル名の重複チェック
- 追加後、自動的に再indexを実行するか確認ダイアログ表示

#### 4.1.4 既存Knowledgeファイル削除
- ファイル一覧から削除対象を選択
- 「削除」ボタンで確認ダイアログ表示
- 確認後、ファイルを削除
- 削除後、自動的に再indexを実行するか確認ダイアログ表示

#### 4.1.5 Knowledge更新機能
- ファイル内容を編集可能（将来拡張）
- 更新後、再indexを実行

#### 4.1.6 RAG再読み込み（再index）
- 「Knowledge再読み込み」ボタンで実行
- 実行前に確認ダイアログ表示
- 再index中は進捗表示
- 完了後、成功/失敗メッセージを表示
- 再index中はRAG検索を一時停止

### 4.2 ログ管理機能

#### 4.2.1 RAG検索ログの閲覧
以下の情報を表示：

- **基本情報**
  - ログID（自動生成）
  - 検索実行日時
  - 実行ユーザー（一般ユーザー名またはID）
  - 案件ID

- **入力情報**
  - 入力された案件内容（JSON形式または構造化表示）
  - 修理種別
  - 緊急度
  - 現場情報

- **RAG検索情報**
  - 内部質問（RAGクエリ）の一覧
  - 各質問に対する検索結果数
  - 参照されたKnowledgeファイル名の一覧
  - 各ファイルの参照スコア（類似度）

- **生成情報**
  - 生成された回答（全文）
  - 回答生成にかかった時間
  - 使用したLLMモデル名
  - トークン使用量（可能であれば）

#### 4.2.2 ログ検索・フィルタリング
- 日時範囲で検索
- ユーザー別で検索
- 案件IDで検索
- 修理種別でフィルタリング
- 参照されたKnowledgeファイル名で検索

#### 4.2.3 ログ詳細表示
- ログ一覧から詳細をクリックで表示
- 全情報を構造化して表示
- ログのエクスポート機能（CSV形式、PoCでは簡易実装）

#### 4.2.4 ログ保存形式
- PoCではSQLiteデータベースに保存
- テーブル構成：
  - `rag_logs`テーブル
    - id (INTEGER PRIMARY KEY)
    - timestamp (DATETIME)
    - user_id (TEXT)
    - case_id (TEXT)
    - input_data (JSON/TEXT)
    - rag_queries (JSON/TEXT)
    - referenced_files (JSON/TEXT)
    - generated_answer (TEXT)
    - processing_time (REAL)
    - model_name (TEXT)

### 4.3 管理者UI要件

#### 4.3.1 admin専用画面
- 一般ユーザー画面とは別のルート（例：`/admin`）
- 簡易認証（PoCでは固定パスワードまたはセッション管理）

#### 4.3.2 操作のシンプルさ
- 確認・削除・更新を中心とした操作
- ワンクリックで実行できる操作を優先
- 複雑な設定画面は避ける

#### 4.3.3 誤削除防止
- 削除操作には必ず確認ダイアログを表示
- 確認ダイアログには削除対象のファイル名を明示
- 削除操作はログに記録

#### 4.3.4 画面構成
- サイドバーまたはタブで機能を切り替え
  - Knowledge管理
  - ログ閲覧
  - システム設定（将来拡張用）

---

## 5. RAG設計

### 5.1 Knowledgeの検索単位

- **基本単位**：txtファイル単位
- **chunk単位**：ファイル内の段落またはセクション単位
- **推奨chunkサイズ**：200〜500文字程度（小さめを推奨）
- **chunk分割方法**：
  - 空行で区切る
  - 見出し（## など）で区切る
  - 固定文字数で分割（最後の手段）

### 5.2 chunk設計

#### 5.2.1 chunk分割方針
- 意味的なまとまりを優先
- 1つのchunkに1つの概念を含める
- 重複を避ける（オーバーラップは最小限）
- 既存の30個のKnowledgeファイルを適切にchunk分割

#### 5.2.2 chunkメタデータ
各chunkに以下のメタデータを付与：

- `file_name`：元のファイル名（例：`repair_leakage_water_tank.txt`）
- `file_type`：ファイル種別（repair_*、contractor_*、price_*など）
- `chunk_index`：ファイル内のchunk番号
- `section_title`：セクション名（あれば）

### 5.3 想定される内部質問パターン

RAG検索時に、以下の内部質問を自動生成して実行：

#### 5.3.1 業者選定に関する質問
- 「[修理種別]の修理に対応可能な業者の選定基準は？」
- 「[緊急度]の案件に対応可能な業者は？」
- 「[価格帯]の予算で対応可能な業者は？」

#### 5.3.2 価格に関する質問
- 「[修理種別]の修理の相場価格は？」
- 「[規模]の貯水槽の[修理種別]修理の価格は？」
- 「[修理種別]の高額/低額ケースの理由は？」

#### 5.3.3 修理内容に関する質問
- 「[修理種別]の修理方法・手順は？」
- 「[修理種別]の難易度は？」
- 「[修理種別]の過去事例は？」

#### 5.3.4 緊急度・リスクに関する質問
- 「[修理種別]の緊急度判断基準は？」
- 「[修理種別]のリスク・注意事項は？」
- 「[修理種別]に関連する法令・安全要件は？」

### 5.4 回答生成プロンプト方針

#### 5.4.1 プロンプト構造
```
あなたはビルメンテナンス業務の専門家です。
以下の情報を基に、貯水槽修理案件の判断支援情報を提供してください。

【案件情報】
{案件情報を構造化して挿入}

【参考情報】
{検索されたKnowledgeチャンクを挿入}

【出力要件】
1. 推奨業者候補（最大3社）と選定理由
2. 想定価格情報（相場・人件費・材料費）
3. 判断理由（参照したKnowledgeファイル名を明記）
4. リスク・注意事項
5. 緊急度評価と理由

【重要】
- 判断理由には必ず参照したKnowledgeファイル名を含めること
- 不確実な情報は推測ではなく「情報不足」と明記すること
- 最終判断はユーザーが行うことを前提に、支援情報を提供すること
```

#### 5.4.2 プロンプトのカスタマイズ
- 修理種別に応じてプロンプトを調整可能にする
- adminがプロンプトを編集できる機能（将来拡張）

### 5.5 「価格・業者・緊急度・リスク」を統合する方法

#### 5.5.1 マルチクエリ戦略
1. **並列検索**：複数の内部質問を並列で実行
2. **結果統合**：各検索結果を統合して回答生成
3. **重み付け**：検索結果の信頼度に応じて重み付け

#### 5.5.2 統合プロンプト
```
以下の4つの観点から情報を統合してください：

1. 価格情報：{価格関連の検索結果}
2. 業者情報：{業者関連の検索結果}
3. 緊急度情報：{緊急度関連の検索結果}
4. リスク情報：{リスク関連の検索結果}

これらを統合して、一貫性のある判断支援情報を生成してください。
```

#### 5.5.3 検索結果の優先順位
- 複数のKnowledgeファイルから情報が得られた場合、より具体的な情報を優先
- 過去事例がある場合は、それを優先
- 矛盾する情報がある場合は、両方を提示

---

## 6. API設計概要

### 6.1 一般ユーザー用API

#### 6.1.1 案件作成API
```
POST /api/cases
Request Body:
{
  "case_name": "本館貯水槽漏水修理",
  "repair_type": "漏水",
  "urgency": "緊急",
  "location": "本館3階",
  "tank_size": "10トン",
  "description": "貯水槽から水が漏れている"
}

Response:
{
  "case_id": "REP-2024-001",
  "status": "created"
}
```

#### 6.1.2 RAG検索・回答生成API
```
POST /api/rag/search
Request Body:
{
  "case_id": "REP-2024-001",
  "case_info": {
    "repair_type": "漏水",
    "urgency": "緊急",
    ...
  }
}

Response:
{
  "answer": {
    "recommended_contractors": [...],
    "estimated_price": {...},
    "reasoning": {...},
    "risks": [...],
    "urgency_assessment": {...}
  },
  "referenced_files": ["price_leak.txt", "contractor_emergency.txt", ...],
  "processing_time": 2.5
}
```

#### 6.1.3 見積書・発注書生成API
```
POST /api/documents/generate
Request Body:
{
  "case_id": "REP-2024-001",
  "document_type": "estimate", // or "order"
  "selected_contractor": "業者A",
  "price": 500000
}

Response:
{
  "document_url": "/api/documents/download/xxx",
  "document_id": "DOC-xxx"
}
```

### 6.2 admin用API（Knowledge操作）

#### 6.2.1 Knowledgeファイル一覧取得API
```
GET /api/admin/knowledge/files

Response:
{
  "files": [
    {
      "filename": "price_leak.txt",
      "size": 1024,
      "updated_at": "2024-01-01T00:00:00",
      "file_type": "price"
    },
    ...
  ]
}
```

#### 6.2.2 Knowledgeファイル内容取得API
```
GET /api/admin/knowledge/files/{filename}

Response:
{
  "filename": "price_leak.txt",
  "content": "ファイル内容...",
  "size": 1024,
  "updated_at": "2024-01-01T00:00:00"
}
```

#### 6.2.3 Knowledgeファイル追加API
```
POST /api/admin/knowledge/files
Request Body:
{
  "filename": "new_knowledge.txt",
  "content": "ファイル内容..."
}

Response:
{
  "filename": "new_knowledge.txt",
  "status": "created",
  "message": "ファイルが追加されました"
}
```

#### 6.2.4 Knowledgeファイル削除API
```
DELETE /api/admin/knowledge/files/{filename}

Response:
{
  "filename": "deleted_file.txt",
  "status": "deleted",
  "message": "ファイルが削除されました"
}
```

#### 6.2.5 RAG再index API
```
POST /api/admin/knowledge/reindex

Response:
{
  "status": "success",
  "message": "再indexが完了しました",
  "indexed_files": 25,
  "processing_time": 10.5
}
```

### 6.3 admin用API（ログ取得）

#### 6.3.1 ログ一覧取得API
```
GET /api/admin/logs?start_date=2024-01-01&end_date=2024-01-31&user_id=user1&repair_type=漏水

Response:
{
  "logs": [
    {
      "log_id": 1,
      "timestamp": "2024-01-01T10:00:00",
      "user_id": "user1",
      "case_id": "REP-2024-001",
      "repair_type": "漏水",
      "referenced_files": ["price_leak.txt", ...]
    },
    ...
  ],
  "total": 100
}
```

#### 6.3.2 ログ詳細取得API
```
GET /api/admin/logs/{log_id}

Response:
{
  "log_id": 1,
  "timestamp": "2024-01-01T10:00:00",
  "user_id": "user1",
  "case_id": "REP-2024-001",
  "input_data": {...},
  "rag_queries": [...],
  "referenced_files": [...],
  "generated_answer": "...",
  "processing_time": 2.5,
  "model_name": "gpt-4"
}
```

### 6.4 RAG呼び出しAPI（内部用）

#### 6.4.1 RAG検索実行API
```
POST /api/internal/rag/search
Request Body:
{
  "queries": [
    "漏水修理の相場価格は？",
    "緊急対応可能な業者は？",
    ...
  ],
  "case_info": {...}
}

Response:
{
  "results": [
    {
      "query": "漏水修理の相場価格は？",
      "chunks": [...],
      "referenced_files": [...]
    },
    ...
  ]
}
```

### 6.5 認証API（PoC簡易版）

#### 6.5.1 adminログインAPI
```
POST /api/admin/login
Request Body:
{
  "password": "admin_password"
}

Response:
{
  "status": "success",
  "session_token": "xxx"
}
```

---

## 7. 画面構成

### 7.1 一般ユーザー画面

#### 7.1.1 修理案件入力画面
- **URL**：`/cases/new`
- **構成**：
  - ヘッダー（ロゴ・ナビゲーション）
  - フォームエリア
    - 案件名入力
    - 修理種別選択（ドロップダウン）
    - 緊急度選択（ラジオボタン）
    - 現場情報入力（テキストエリア）
    - 詳細説明入力（テキストエリア）
  - 送信ボタン
- **動作**：送信後、RAG検索を自動実行し、回答表示画面に遷移

#### 7.1.2 RAG回答表示画面
- **URL**：`/cases/{case_id}/answer`
- **構成**：
  - ヘッダー
  - 案件情報表示（読み取り専用）
  - RAG回答表示エリア
    - 推奨業者候補（カード形式）
    - 想定価格情報（カード形式）
    - 判断理由（折りたたみ可能）
    - リスク・注意事項（リスト形式）
    - 緊急度評価（カード形式）
  - 操作ボタン
    - 再検索ボタン
    - 見積書生成ボタン
    - 発注書生成ボタン
    - PDF出力ボタン
- **動作**：各ボタンで対応する機能を実行

#### 7.1.3 見積書・発注書編集画面
- **URL**：`/documents/{document_id}/edit`
- **構成**：
  - ヘッダー
  - ドラフト表示エリア（編集可能）
  - 保存ボタン
  - PDFダウンロードボタン

### 7.2 管理者画面

#### 7.2.1 adminログイン画面
- **URL**：`/admin/login`
- **構成**：
  - ログインフォーム
  - パスワード入力
  - ログインボタン

#### 7.2.2 Knowledge一覧画面
- **URL**：`/admin/knowledge`
- **構成**：
  - ヘッダー（adminメニュー）
  - 検索・フィルタエリア
    - ファイル名検索
    - ファイル種別フィルタ
  - ファイル一覧テーブル
    - ファイル名
    - ファイルサイズ
    - 最終更新日時
    - ファイル種別
    - 操作ボタン（閲覧・削除）
  - 「新規追加」ボタン
  - 「Knowledge再読み込み」ボタン

#### 7.2.3 Knowledge詳細表示画面
- **URL**：`/admin/knowledge/{filename}`
- **構成**：
  - ヘッダー
  - ファイル情報表示
    - ファイル名
    - ファイルサイズ
    - 最終更新日時
  - ファイル内容表示（テキストエリア、読み取り専用）
  - 操作ボタン
    - 戻るボタン
    - 削除ボタン（確認ダイアログ付き）

#### 7.2.4 Knowledge追加画面
- **URL**：`/admin/knowledge/new`
- **構成**：
  - ヘッダー
  - フォームエリア
    - ファイル名入力
    - ファイル内容入力（テキストエリア）
  - 保存ボタン
  - キャンセルボタン

#### 7.2.5 ログ閲覧画面
- **URL**：`/admin/logs`
- **構成**：
  - ヘッダー（adminメニュー）
  - 検索・フィルタエリア
    - 日時範囲選択
    - ユーザー選択
    - 案件ID検索
    - 修理種別フィルタ
  - ログ一覧テーブル
    - ログID
    - 検索実行日時
    - ユーザー
    - 案件ID
    - 修理種別
    - 参照ファイル数
    - 操作ボタン（詳細表示）
  - エクスポートボタン（CSV）

#### 7.2.6 ログ詳細表示画面
- **URL**：`/admin/logs/{log_id}`
- **構成**：
  - ヘッダー
  - ログ情報表示
    - 基本情報（日時・ユーザー・案件ID）
    - 入力情報（構造化表示）
    - RAG検索情報（内部質問・検索結果）
    - 参照ファイル一覧（ファイル名・スコア）
    - 生成回答（全文）
    - 処理時間・モデル名
  - 戻るボタン

### 7.3 共通UIコンポーネント

- **ヘッダー**：ロゴ・ナビゲーション・ユーザー情報
- **フッター**：コピーライト・リンク
- **ローディング表示**：検索中・処理中の表示
- **エラーメッセージ表示**：エラー発生時の表示
- **確認ダイアログ**：削除などの確認用

---

## 8. PoC前提・注意点

### 8.1 PoCとしての割り切りポイント

#### 8.1.1 認証
- **簡易認証**：adminは固定パスワードまたはセッション管理
- **一般ユーザー**：認証なし（PoCではユーザーIDを手動入力）
- **本番では**：適切な認証システム（OAuth、JWTなど）に差し替え

#### 8.1.2 Knowledgeデータ
- **仮データ前提**：`knowledge/`ディレクトリに仮のtxtファイルを配置
- **実在業者・実価格ではない**：すべて仮想データ
- **本番では**：実データに差し替え

#### 8.1.3 データベース
- **PoCでは**：SQLiteを使用（ログ保存のみ）
- **本番では**：PostgreSQLやMySQLなどの本格DBに差し替え

#### 8.1.4 UI
- **PoCでは**：シンプルなWeb UI（BootstrapまたはTailwind CSS）
- **本番では**：より洗練されたUI/UXに改善

#### 8.1.5 エラーハンドリング
- **PoCでは**：基本的なエラーハンドリングのみ
- **本番では**：詳細なエラーログ・監視システムを追加

### 8.2 本番環境で追加すべき機能

1. **権限管理**
   - ロールベースアクセス制御（RBAC）
   - 一般ユーザー・管理者・スーパー管理者の階層

2. **監査ログ**
   - すべての操作を記録
   - 改ざん防止

3. **バックアップ・復旧**
   - Knowledgeファイルのバックアップ
   - データベースのバックアップ

4. **パフォーマンス最適化**
   - RAG検索のキャッシュ
   - 並列処理の最適化

5. **セキュリティ強化**
   - 入力値のサニタイズ
   - SQLインジェクション対策
   - XSS対策

6. **通知機能**
   - Knowledge更新時の通知
   - エラー発生時の通知

7. **分析機能**
   - RAG検索の効果測定
   - よく参照されるKnowledgeの分析

### 8.3 設計思想の再確認

- **AIは「判断支援者」**：最終決定は人間が行う
- **管理者がKnowledgeを制御**：Knowledgeの内容を管理者が完全にコントロールできる
- **属人判断の可視化・再利用**：過去の判断をKnowledgeとして蓄積
- **PoCだが本番に耐える構造**：拡張性・保守性を考慮した設計

### 8.4 実装時の注意点

1. **Knowledgeファイルの形式**
   - txtファイルの文字コードはUTF-8を推奨
   - ファイル名の命名規則は既存の30個のファイルに準拠
   - 既存Knowledgeディレクトリ：`/Users/takuminittono/Desktop/ragstudy/ラグルール/knowledge/`
   - システム実装時は、このディレクトリを参照する設定が必要

2. **RAG検索のタイムアウト**
   - 長時間かかる検索のタイムアウト設定（例：30秒）

3. **再indexの実行タイミング**
   - 再index中はRAG検索を一時停止
   - 再indexの進捗を表示

4. **ログの保存期間**
   - PoCでは無制限、本番では保存期間を設定

5. **LLM APIのレート制限**
   - OpenAI APIのレート制限を考慮
   - リトライロジックの実装

---

## 付録：Knowledgeファイル構成（既存ファイル）

### 既存Knowledgeファイル一覧（30個）

既存のKnowledgeファイルは以下のディレクトリに配置されています：
`/Users/takuminittono/Desktop/ragstudy/ラグルール/knowledge/`

#### ＜修理内容・症状別の知識＞
- `repair_leakage_water_tank.txt` - 貯水槽の水漏れ修理に関する知識
- `repair_corrosion_rust.txt` - 腐食・錆びに関する知識
- `repair_crack_damage.txt` - ひび割れ・損傷に関する知識
- `repair_valve_pipe_fitting.txt` - バルブ・配管継手の修理に関する知識
- `repair_lid_cover.txt` - 蓋・カバーの修理に関する知識
- `repair_water_quality_issue.txt` - 水質問題に起因する修理に関する知識

#### ＜下請け業者選定基準＞
- `contractor_selection_criteria.txt` - 下請け業者選定の基本基準
- `contractor_by_repair_type.txt` - 修理内容別の推奨業者タイプ
- `contractor_emergency_response.txt` - 緊急案件対応可能な業者の選定基準
- `contractor_price_range.txt` - 業者タイプ別の金額相場

#### ＜金額判断基準＞
- `price_standard_by_repair_type.txt` - 修理内容別の金額相場
- `price_factors_influence.txt` - 金額に影響する要因の詳細
- `price_high_case_scenarios.txt` - 金額が高くなるケースの具体例
- `price_low_suspicious_case.txt` - 金額が異常に安い場合の注意点
- `price_material_cost.txt` - 材料費の相場と判断基準
- `price_labor_cost.txt` - 人件費・工数の判断基準

#### ＜法的・規制関連＞
- `legal_regulation_water_tank.txt` - 貯水槽に関する法的規制
- `safety_standard_repair.txt` - 修理工事の安全基準

#### ＜過去事例・判断基準＞
- `past_case_study.txt` - 過去の修理事例と判断結果
- `decision_pattern_by_symptom.txt` - 症状別の判断パターン
- `common_mistakes_lessons.txt` - 過去の失敗事例と教訓

#### ＜見積書・発注書作成基準＞
- `estimate_required_items.txt` - 見積書に必要な記載事項
- `order_form_required_items.txt` - 発注書に必要な記載事項
- `estimate_comparison_method.txt` - 複数見積もりの比較方法

#### ＜緊急度・優先度判断＞
- `urgency_priority_judgment.txt` - 緊急度・優先度の判断基準
- `water_supply_impact_assessment.txt` - 給水への影響評価

#### ＜材料・部品に関する知識＞
- `material_selection_criteria.txt` - 材料選定の基準
- `part_replacement_judgment.txt` - 部品交換の判断基準

#### ＜工事方法・技術的判断＞
- `construction_method_selection.txt` - 工事方法の選定基準
- `difficulty_assessment.txt` - 工事難易度の評価基準

#### ＜リスク評価＞
- `risk_assessment_repair.txt` - 修理案件のリスク評価
- `warranty_guarantee_standard.txt` - 保証・保証内容の基準

#### ＜その他・実務判断＞
- `seasonal_timing_consideration.txt` - 季節・タイミングの考慮事項
- `building_type_consideration.txt` - 建物タイプ別の考慮事項
- `communication_with_contractor.txt` - 業者とのコミュニケーション基準

#### ＜索引ファイル＞
- `knowledge_index.md` - Knowledgeファイルの詳細説明と利用目的

**合計：30個のKnowledgeファイル + 1個の索引ファイル**

### Knowledgeファイルの詳細説明

各ファイルの詳細な内容と利用目的については、`knowledge_index.md`を参照してください。

---

**作成日**：2024年1月  
**バージョン**：1.0  
**作成者**：システム設計者

